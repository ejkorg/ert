%% Cebu Camstar Wafer Sort Genealogy Extraction Flow
%% Source refb_ingest/getCebuCamstarWaferSortGenealogy.csh
%% Keep labels simple to avoid render errors

flowchart TD
  A([Start])
  RZ[Reason collect wafer sort genealogy for analytics]
  IT[Intention produce genealogy events for ERT]

  INP[Inputs oracle user and password and sid and hours back]
  ENV[Env REFERENCE_DATA_DIR must exist]
  VARGS{Args count is 4}
  VPW{If password token is YMS_PASSWORD then env YMS_PASSWORD must exist}
  UX[[Exit with usage]]

  CREDS[Build credentials maybe from YMS_PASSWORD]
  VARS[Set date code and archive and dirs and filenames]

  MKSQL[Write SQL script to temp]
  RUN[Run sqlplus with script]
  LOG[Write log file]
  SPOOL[Spool rows to tmp file]
  ERRCHK[Check tmp for ERROR or ORA lines]
  EMAIL[Send email to admins when error]
  ARCH[Copy tmp to archive and gzip]
  MOVE[Move tmp to final output]
  CLEAN[Remove temporary SQL script]
  ENDN([End])

  T1[BIWMES CAMSTAR_WIPLTH]
  T2[BIWMES CAMSTAR_SPEC]
  T3[BIWMES CAMSTAR_PRODUCT]
  T4[BIWMES CAMSTAR_LOTATTRIBUTES]
  T5[BIWMES WKSM_WIPLTH_SUM]

  DATA[Data extracted business unit and parent lot and child lot and products and owner and trans and transaction date time and source lot and source prod]
  OUTS[Outputs CebuCamstarWaferSortGenealogy dateCode cmes]

  A --> RZ --> IT --> INP --> ENV --> VARGS
  VARGS -- no --> UX
  VARGS -- yes --> VPW
  VPW -- no --> UX
  VPW -- yes --> CREDS --> VARS --> MKSQL --> RUN --> LOG --> SPOOL --> ERRCHK
  ERRCHK -- has error --> EMAIL --> CLEAN --> ENDN
  ERRCHK -- ok --> ARCH --> MOVE --> CLEAN --> ENDN

  RUN -. queries .-> T1
  RUN -. queries .-> T2
  RUN -. queries .-> T3
  RUN -. queries .-> T4
  RUN -. queries .-> T5

  MKSQL --> DATA
  MOVE --> OUTS
