flowchart TD
    %% REST layer
    Client[(Client / Integration)] --> Controller[OnLotController]
    Controller --> Normalize[Uppercase lotId / params]
    Normalize --> Service[OnLotService.findByLotId]

    %% Repository checkpoint
    Service --> RepoFind[OnLotRepository.findByLot]
    RepoFind -- hit && status complete --> ReturnCached[Map entity ➜ OnLotDto]
    ReturnCached --> Respond[(HTTP 200 JSON)]

    %% Enrichment path
    RepoFind -- miss or incomplete --> Config[Resolve configuration]
    Config --> FabConf[OnFabConfService.getByFabAndDataType]
    Config --> SiteConf[OnSiteConfRepository.getBySite]
    Config --> ErtConf[ErtConfService]

    %% LotG native DB
    FabConf --> LotgNative[LotgInfoService.getLotGInfo]
    SiteConf --> LotTrim[Apply LotTrimRule (optional)]
    LotTrim --> LotgNative
    LotgNative --> Merge

    %% Second LotG heuristics
    FabConf --> SecondLotg{secondLotgQuery?
(JND/Bucheon rules)}
    SecondLotg --> LotgNative

    %% LotG WS (manufacturing lot)
    ErtConf --> LotgWS[Caller.getLotg (WS_LOTG_URL)]
    FabConf --> LotgWS
    LotgWS --> Merge

    %% LTM Web Service
    FabConf --> LtmWS[Caller.getLtm (ltmUrl / lotidForLTM)]
    LtmWS --> Merge

    %% Data Warehouse
    MergeInputs[LotG alt product & fab] -.-> DWPlm[DataWarehouseService.getDwPlmByPartId]
    MergeInputs -.-> DWMfg[DataWarehouseService.getMfgAreaByMfgAreaCd]
    DWPlm --> Merge
    DWMfg --> Merge

    %% MES paths
    SiteConf --> MesType{mesType}
    MesType -- TORRENT --> Torrent[TorrentService.getMesDto]
    MesType -- GENESIS --> Genesis[GenesisService.getMesDto]
    MesType -- other/blank --> SkipMes[Skip MES]
    Torrent --> Merge
    Genesis --> Merge
    SkipMes --> Merge

    %% Merge & persistence
    Merge --> AdjustSourceLot[Apply sourceLotAdjustmentPattern (clone only)]
    AdjustSourceLot --> Statuses[setStatuses ➜ Status enum]
    Statuses --> Persist{Can persist?}
    Persist -- yes --> SaveLot[OnLotRepository.save]
    Persist -- yes --> SaveProd[OnProdRepository.save]
    SaveLot --> ReturnCached
    Persist -- no --> ReturnCached

    %% Cross links
    MergeInputs -.-> Merge
    SaveProd -.-> Respond
    ReturnCached --> Respond
